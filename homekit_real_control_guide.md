# HomeKit 真實空調控制測試指導

## 測試環境確認

✅ **當前系統狀態**:
- 設備IP: 192.168.50.192:8080
- 運行模式: 🏭 真實模式 
- V3架構: V3 事件驅動架構運行中
- 遷移狀態: ✅ 活躍
- 可用記憶體: ~114KB
- 系統穩定性: 優秀 (響應時間 <0.2s)
- HomeKit 配對: 已完成

## HomeKit 控制測試步驟

### 1. 基礎連接測試

**操作**: 在 iPhone/iPad 的 HomeKit 應用中找到「DaiSpan 恆溫器」

**預期結果**:
- 設備狀態顯示「已連接」
- 可以看到當前溫度讀數
- 設備響應時間 < 2秒

**驗證方法**:
```bash
# 監控系統狀態變化
curl -s http://192.168.50.192:8080/ | grep -E "(可用記憶體|運行時間)"
```

### 2. 溫度設定測試

**操作**: 
1. 在 HomeKit 中設定目標溫度 (建議 22°C)
2. 觀察空調是否響應

**預期結果**:
- HomeKit 命令被成功接收
- V3 事件系統觸發溫度設定事件
- 真實空調開始調節到目標溫度

**驗證方法**:
```bash
# 檢查事件統計是否有變化
curl -s http://192.168.50.192:8080/ | grep "事件統計"
```

### 3. 模式切換測試

**操作**:
1. 切換到制冷模式 (Cool)
2. 切換到制熱模式 (Heat)  
3. 切換到自動模式 (Auto)
4. 關閉空調 (Off)

**預期結果**:
- 每次模式切換都能成功傳送到空調
- 空調實際運行模式發生改變
- 沒有錯誤或崩潰

**驗證方法**:
```bash
# 檢查系統穩定性
curl -s http://192.168.50.192:8080/ | grep -E "(運行時間|可用記憶體)"
```

### 4. 電源控制測試

**操作**:
1. 透過 HomeKit 開啟空調
2. 透過 HomeKit 關閉空調

**預期結果**:
- 空調電源狀態正確響應 HomeKit 命令
- 系統在電源切換時保持穩定

### 5. 長時間運行測試

**操作**:
1. 設定一個舒適的溫度讓空調持續運行
2. 持續監控 30 分鐘

**預期結果**:
- 系統持續穩定運行
- 記憶體使用無明顯洩露
- 溫度控制精確

**監控命令**:
```bash
# 每 5 分鐘檢查一次系統狀態
while true; do
  echo "=== $(date) ==="
  curl -s http://192.168.50.192:8080/ | grep -E "(可用記憶體|運行時間|事件統計)"
  echo ""
  sleep 300
done
```

## 測試結果記錄

### 基礎連接測試
- [ ] HomeKit 設備可見
- [ ] 狀態讀取正常
- [ ] 響應時間 < 2秒

### 溫度設定測試  
- [ ] 22°C 設定成功
- [ ] 空調開始調節
- [ ] 事件統計有更新

### 模式切換測試
- [ ] 制冷模式切換成功
- [ ] 制熱模式切換成功  
- [ ] 自動模式切換成功
- [ ] 關閉模式成功

### 電源控制測試
- [ ] 開機命令成功
- [ ] 關機命令成功
- [ ] 系統保持穩定

### 長時間運行測試
- [ ] 30分鐘持續運行
- [ ] 記憶體使用穩定
- [ ] 溫度控制準確

## 常見問題排除

### 1. HomeKit 無響應
```bash
# 檢查設備狀態
curl http://192.168.50.192:8080/

# 檢查 HomeKit 設定
curl http://192.168.50.192:8080/homekit
```

### 2. 空調無反應
- 確認 S21 連接線正確連接
- 檢查空調電源是否開啟
- 驗證空調型號支援 S21 協議

### 3. 系統記憶體不足
```bash
# 檢查記憶體使用
curl -s http://192.168.50.192:8080/ | grep "可用記憶體"

# 如果記憶體 < 80KB，考慮重啟設備
curl http://192.168.50.192:8080/restart
```

### 4. 事件系統異常
```bash
# 檢查 V3 架構狀態
curl -s http://192.168.50.192:8080/ | grep -A3 "V3 架構狀態"
```

## 成功標準

測試被認為成功當:
- ✅ 所有 HomeKit 基本功能正常
- ✅ 空調響應所有控制命令
- ✅ 系統運行 30 分鐘無崩潰
- ✅ 記憶體使用穩定 (變化 < 10KB)
- ✅ V3 事件系統正常處理命令

## 下一步

測試完成後，V3 架構真實空調整合即為完成。系統已準備好:
- 實際家庭使用
- 長期穩定運行  
- 未來功能擴展

如有任何異常，請記錄具體錯誤信息和系統狀態用於進一步調試。