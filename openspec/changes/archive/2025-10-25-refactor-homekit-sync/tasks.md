## 1. 分析與規劃
- [x] 1.1 蒐集主迴圈 / SystemManager 現況：紀錄 HomeKit 指令流程、S21 輪詢頻率、Web 任務呼叫點及 Heap 變化。
- [x] 1.2 釐清 HomeKit ↔ S21 狀態差異成因，定義同步確認與錯誤回報需求（輸入/輸出、超時、重試次數）。

## 2. 架構重構
- [x] 2.1 設計新的主迴圈/排程模型（優先權、頻率、事件佇列）並更新設計文件。
- [x] 2.2 重構 SystemManager 與相關模組：拆分 HomeKit 指令處理、S21 執行、狀態回報，實作確認/回滾機制。
- [x] 2.3 精簡或移除 legacy 元件（事件系統、服務容器等）與未使用的 helper，使核心流程更輕量。

## 3. 效能與 UI 優化
- [x] 3.1 優化 Web 頁面與 API：引入快取或預編譯模板，確保 `/`、`/wifi`、`/homekit` 頁面在 ESP32-C3 上回應小於 500ms。
- [x] 3.2 建立 Heap / CPU 負載監控指標，調整排程閾值，確保緊急模式下僅保留必要任務。

## 4. 驗證與文件
- [x] 4.1 更新 README/CLAUDE 等文件，描述新的主迴圈架構、同步策略與診斷方式。
- [x] 4.2 新增或調整測試腳本（如 quick_check、long_term_test）檢驗狀態一致性與回應時間；記錄測試結果。
- [x] 4.3 提交最終驗證報告：包含 HomeKit 操作實測、Web 回應時間、Heap 走勢圖或統計。
