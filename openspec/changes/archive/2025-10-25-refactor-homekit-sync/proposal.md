## Why
- 現行主迴圈混合多層職責，HomeKit 指令處理與 S21 資料輪詢彼此交錯，導致常見的「在 HomeKit App 操作已變更但實際設備未同步」或狀態回報延遲的問題。
- Wi-Fi / Web 相關工作與 HomeKit 控制同時在主線程繁忙運作，記憶體壓力過高、網頁回應偏慢，影響到日常操作與維護。
- 目前架構仍保留許多 legacy 模組（事件系統、排程器等）但整合鬆散，需要重新整理並定義清楚的狀態流與資源調度，以避免未來邏輯／效能問題重演。

## What Changes
- 重構主迴圈與 SystemManager，將 HomeKit 指令→S21 執行→狀態回報拆分為明確階段，並加入「同步確認」與重試/回滾機制，確保 HomeKit 與實體設備狀態一致。
- 建立新的排程與事件分派模型：HomeKit 相關處理優先、S21 輪詢節流、Web/UI 任務走低優先佇列，同時監控 Heap 以調整頻率。
- 精簡與模組化現有架構：盤點事件系統、服務容器等 legacy 元件，移除無用或過度設計的部分，將必要邏輯整合到新的核心流程。
- 優化 Web 生成與 API：引入快取或預編譯模板（保證小記憶體 footprint），並為 `/api/memory/*`、`/` 首頁提供限時內回應的保證。
- 強化檢測/診斷：新增狀態一致性監控與主迴圈負載指標，提供腳本與文件說明如何驗證。

## Impact
- HomeKit App 操作後的狀態會更快速且可靠地反映在實際設備與 UI 上，減少錯誤與使用者困惑。
- 主迴圈與 Web 任務的資源使用將受控，避免記憶體飆升與網頁回應緩慢，提升整體效能與穩定度。
- 架構簡化後後續維護與擴充變得更容易，降低後續優化或功能開發的風險。
